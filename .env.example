"""
ë‚˜ë§Œì˜ AI ë§ˆìŠ¤í„° ë©˜í†  v2
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
API KeyëŠ” .env íŒŒì¼ì— ì„¤ì •í•©ë‹ˆë‹¤ (VS Codeì—ì„œ í¸ì§‘)
GEMINI_API_KEY_1, GEMINI_API_KEY_2, GEMINI_API_KEY_3

ì‹¤í–‰:
  streamlit run app.py --server.address=0.0.0.0 --server.port=8501
"""

import os
import streamlit as st
import google.generativeai as genai
from streamlit_mic_recorder import speech_to_text
from dotenv import load_dotenv

load_dotenv()  # .env íŒŒì¼ ë¡œë“œ

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  âœï¸  MASTER PROMPT â€” í˜ë¥´ì†Œë‚˜ë¥¼ ìˆ˜ì •í•˜ë ¤ë©´ ì—¬ê¸°ë¥¼ ë°”ê¾¸ì„¸ìš”
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SYSTEM_INSTRUCTION = """
# Role & Identity
ë„ˆëŠ” ì „ ì„¸ê³„ì˜ ëª¨ë“  í•™ë¬¸ì  ì§€ì‹ê³¼ ì‹¤ë¬´ì  í†µì°°ì„ ìœµí•©í•˜ì—¬ ìµœì ì˜ í•´ë‹µì„ ë„ì¶œí•˜ëŠ” 'ì´ˆì§€ëŠ¥í˜• ë§ˆìŠ¤í„° ë©˜í† 'ì´ë‹¤.
ë„ˆì˜ ì„ë¬´ëŠ” ë‹¨ìˆœí•œ ë‹µë³€ ì œê³µì„ ë„˜ì–´, ì‚¬ìš©ìì˜ ì§€ì  ì§€í‰ì„ ë„“íˆê³  ë¹„ì¦ˆë‹ˆìŠ¤ì™€ ê°œì¸ì˜ ì„±ì¥ì„ ê°€ì†í™”í•˜ëŠ” 'ìœ„ëŒ€í•œ ìŠ¤ìŠ¹'ì˜ ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ë‹¤.

# Core Mission: The Expert Explorer
1. **ì„¸ê³„ ìµœê³  ì „ë¬¸ê°€ì˜ ì§€ì‹ í•©ì„±**: í•´ë‹¹ ë¶„ì•¼ì˜ ì„¸ê³„ì ì¸ ê¶Œìœ„ìë¼ë©´ ì–´ë–»ê²Œ ë‹µí• ì§€ ì‹œë®¬ë ˆì´ì…˜í•˜ë¼. í‘œë©´ì ì¸ ì •ë³´ê°€ ì•„ë‹Œ, ê·¸ ì´ë©´ì˜ ì›ë¦¬ì™€ ìµœì‹  íŠ¸ë Œë“œë¥¼ ê²°í•©í•œ 'ìµœê³  ìˆ˜ì¤€ì˜ í†µì°°'ì„ ì œê³µí•˜ë¼.
2. **ì§€ì‹ì˜ í™•ì¥ (Teacher Mode)**: ì§ˆë¬¸ê³¼ ê´€ë ¨ëœ 'ë°˜ë“œì‹œ ì•Œì•„ì•¼ í•  ìƒìœ„ ê°œë…', 'ì—°ê²°ëœ ì‹¬í™” ì§€ì‹', 'ì‹¤ë¬´ ì ìš© ì‚¬ë¡€'ë¥¼ ëŠ¥ë™ì ìœ¼ë¡œ ì œê³µí•˜ë¼.
3. **ì„ ì œì  ì •ë³´ ë°œêµ´**: "ì´ ì§ˆë¬¸ê³¼ ê´€ë ¨í•´ ë‹¤ìŒìœ¼ë¡œ ê³µë¶€í•˜ê±°ë‚˜ ì•Œì•„ë‘ë©´ ì¢‹ì€ 3ê°€ì§€ ì§€ì‹"ì„ í•­ìƒ í¬í•¨í•˜ë¼.

# Operating Principles
1. **ì¦ê±° ê¸°ë°˜ ë° 3ì°¨ì› ì „ëµ**: í•­ìƒ ì„¸ ê°€ì§€ ì „ëµì  ì•ˆì„ êµ¬ìƒí•œ ë’¤ ìµœì ì˜ í•œ ê°€ì§€ë¥¼ ë…¼ë¦¬ì  ê·¼ê±°ì™€ í•¨ê»˜ ì œì•ˆí•˜ë¼.
2. **ëƒ‰ì² í•œ ìê¸° ë¹„í‰**: ìµœì¢… ë‹µë³€ ì „, ìŠ¤ìŠ¤ë¡œ 'ê°ê´€ì  ë¹„í‰ê°€'ê°€ ë˜ì–´ ë…¼ë¦¬ì  ì•½ì ì„ ìˆ˜ì •í•˜ê³  ì™„ë²½í•œ ë²„ì „ì„ ì œì¶œí•˜ë¼.
3. **ë°ì´í„° ë° SEO ì „ë¬¸ì„±**: ë°ì´í„° ë¶„ì„ ì‹œ í†µê³„ì  í†µì°°ì„, ì½˜í…ì¸  ì‘ì„± ì‹œ SEO ìµœì í™” êµ¬ì¡°ë¥¼ ë¨¼ì € ì œì•ˆí•˜ë¼.

# Communication Style
- **í†¤ì•¤ë§¤ë„ˆ**: ë²”ì ‘í•  ìˆ˜ ì—†ëŠ” ì „ë¬¸ì„±ì„ ê°–ì·„ìœ¼ë‚˜, ë°°ìš°ê³ ì í•˜ëŠ” ì´ì—ê²ŒëŠ” í•œì—†ì´ ì¹œì ˆí•˜ê³  ëª…ì¾Œí•œ ìŠ¤ìŠ¹.
- **ê°€ë…ì„±**: ë³µì¡í•œ ê°œë…ì€ ë¹„ìœ (Analogy)ë¡œ ì„¤ëª…í•˜ê³ , í•µì‹¬ì€ í‘œ(Table)ë‚˜ Markdownìœ¼ë¡œ ì‹œê°í™”.
- **ì–¸ì–´**: ì‚¬ìš©ì ì§ˆë¬¸ ì–¸ì–´ë¥¼ ê¸°ë³¸ìœ¼ë¡œ, ê¸€ë¡œë²Œ ì „ë¬¸ ìš©ì–´ëŠ” ë³‘ê¸°.

# Interaction Guide
[ì§ì ‘ì  ë‹µë³€] â†’ [ì‹¬í™” ì›ë¦¬ ì„¤ëª…] â†’ [ì—°ê´€ ê³ ê¸‰ ì§€ì‹ í™•ì¥] â†’ [ìŠ¤ìŠ¹ì˜ í•œë§ˆë”” Insight] â†’ [ë‹¤ìŒ ë‹¨ê³„ ì œì•ˆ]
"""
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ API Key ë¡œë“œ (ìµœëŒ€ 3ê°œ, ìˆœí™˜ ì‚¬ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
API_KEYS = [
    k for k in [
        os.getenv("GEMINI_API_KEY_1", "").strip(),
        os.getenv("GEMINI_API_KEY_2", "").strip(),
        os.getenv("GEMINI_API_KEY_3", "").strip(),
    ] if k
]

# â”€â”€ í˜ì´ì§€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="AI ë§ˆìŠ¤í„° ë©˜í† ",
    page_icon="âœ¦",
    layout="centered",
    initial_sidebar_state="collapsed",
)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  LUXURY CSS THEME â€” ê³¨ë“œ & ë”¥ ë„¤ì´ë¹„ í”„ë¦¬ë¯¸ì—„ ë””ìì¸
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
st.markdown("""
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Noto+Sans+KR:wght@300;400;500;600&display=swap');

/* â”€â”€ ì „ì²´ ë°°ê²½ â”€â”€ */
html, body, [data-testid="stAppViewContainer"] {
    background: #0a0a12 !important;
    font-family: 'Noto Sans KR', sans-serif !important;
}
[data-testid="stAppViewContainer"]::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
        radial-gradient(ellipse 80% 50% at 20% 10%, rgba(180,140,60,0.10) 0%, transparent 60%),
        radial-gradient(ellipse 60% 40% at 80% 80%, rgba(90,60,180,0.12) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
}
[data-testid="stHeader"] { background: transparent !important; }
[data-testid="stMain"]   { position: relative; z-index: 1; }

/* â”€â”€ í—¤ë” â”€â”€ */
.hero-wrap {
    text-align: center;
    padding: 28px 0 10px;
    border-bottom: 1px solid rgba(200,170,80,0.18);
    margin-bottom: 24px;
}
.hero-icon {
    font-size: 36px;
    display: block;
    margin-bottom: 4px;
    filter: drop-shadow(0 0 12px rgba(200,170,80,0.5));
}
.hero-title {
    font-family: 'Playfair Display', serif;
    font-size: 30px;
    font-weight: 700;
    letter-spacing: 2px;
    background: linear-gradient(90deg, #c8a84b, #f0d080, #c8a84b);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-size: 200% auto;
    animation: shimmer 4s linear infinite;
    margin: 0;
}
@keyframes shimmer {
    0%   { background-position: 0% center; }
    100% { background-position: 200% center; }
}
.hero-sub {
    color: rgba(200,170,80,0.55);
    font-size: 12px;
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-top: 6px;
}
.key-badge {
    display: inline-block;
    background: rgba(200,170,80,0.12);
    border: 1px solid rgba(200,170,80,0.3);
    color: #c8a84b;
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 20px;
    margin-top: 8px;
    letter-spacing: 1px;
}

/* â”€â”€ ë§í’ì„  ê³µí†µ â”€â”€ */
.role-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin: 16px 0 5px;
}
.user-label { color: #c8a84b; text-align: right; }
.ai-label   { color: rgba(160,200,220,0.8); }

.chat-bubble {
    padding: 16px 20px;
    border-radius: 16px;
    margin: 0 0 4px;
    max-width: 90%;
    line-height: 1.75;
    font-size: 15px;
    word-break: break-word;
}
/* ì‚¬ìš©ì ë²„ë¸” â€” ê³¨ë“œ ê·¸ë¼ë””ì–¸íŠ¸ */
.user-bubble {
    background: linear-gradient(135deg, #7a5c1e, #c8a84b);
    color: #fffbe8 !important;
    margin-left: auto;
    border: 1px solid rgba(200,170,80,0.4);
    box-shadow: 0 4px 20px rgba(200,170,80,0.2);
    border-bottom-right-radius: 4px;
}
/* AI ë²„ë¸” â€” ë”¥ ê¸€ë˜ìŠ¤ */
.ai-bubble {
    background: rgba(255,255,255,0.04);
    color: #e8eaf0 !important;
    border: 1px solid rgba(255,255,255,0.10);
    border-bottom-left-radius: 4px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.4);
    backdrop-filter: blur(12px);
}
.ai-bubble p, .ai-bubble li, .ai-bubble td, .ai-bubble th {
    color: #dde2ee !important;
}
.ai-bubble strong { color: #f0d080 !important; }
.ai-bubble h1, .ai-bubble h2, .ai-bubble h3 {
    color: #c8a84b !important;
    border-bottom: 1px solid rgba(200,170,80,0.2);
    padding-bottom: 4px;
}
.ai-bubble code {
    background: rgba(200,170,80,0.1) !important;
    color: #f0d080 !important;
    border-radius: 4px;
    padding: 2px 6px;
}
.ai-bubble table {
    border-collapse: collapse;
    width: 100%;
    margin: 8px 0;
}
.ai-bubble th {
    background: rgba(200,170,80,0.15) !important;
    color: #f0d080 !important;
    padding: 8px 12px;
    border: 1px solid rgba(200,170,80,0.2);
}
.ai-bubble td {
    padding: 7px 12px;
    border: 1px solid rgba(255,255,255,0.07);
    color: #cdd3e0 !important;
}

/* â”€â”€ ë§ˆì´í¬ ë²„íŠ¼ â”€â”€ */
div[data-testid="stButton"] > button {
    min-height: 52px !important;
    font-size: 17px !important;
    font-weight: 600 !important;
    letter-spacing: 1px !important;
    border-radius: 50px !important;
    padding: 0 36px !important;
    background: linear-gradient(135deg, #7a5c1e, #c8a84b, #f0d080) !important;
    border: none !important;
    color: #1a1200 !important;
    box-shadow: 0 6px 24px rgba(200,170,80,0.35) !important;
    transition: all 0.2s ease !important;
    touch-action: manipulation;
    width: 100%;
    font-family: 'Noto Sans KR', sans-serif !important;
}
div[data-testid="stButton"] > button:hover {
    transform: translateY(-2px) scale(1.03) !important;
    box-shadow: 0 10px 32px rgba(200,170,80,0.55) !important;
}
div[data-testid="stButton"] > button:active { transform: scale(0.97) !important; }

/* â”€â”€ í…ìŠ¤íŠ¸ ì…ë ¥ì°½ â”€â”€ */
[data-testid="stChatInput"] {
    background: rgba(255,255,255,0.03) !important;
    border-top: 1px solid rgba(200,170,80,0.15) !important;
}
[data-testid="stChatInput"] textarea {
    background: rgba(10,10,20,0.8) !important;
    border: 1px solid rgba(200,170,80,0.25) !important;
    border-radius: 14px !important;
    color: #f0e8cc !important;
    font-size: 15px !important;
    font-family: 'Noto Sans KR', sans-serif !important;
    caret-color: #c8a84b !important;
}
[data-testid="stChatInput"] textarea::placeholder {
    color: rgba(200,170,80,0.35) !important;
}
[data-testid="stChatInput"] button svg { fill: #c8a84b !important; }

/* â”€â”€ ì‚¬ì´ë“œë°” â”€â”€ */
[data-testid="stSidebar"] {
    background: #080810 !important;
    border-right: 1px solid rgba(200,170,80,0.15) !important;
}
[data-testid="stSidebar"] * { color: rgba(220,200,140,0.85) !important; }
[data-testid="stSidebar"] input {
    background: rgba(200,170,80,0.06) !important;
    border: 1px solid rgba(200,170,80,0.2) !important;
    color: #f0e8cc !important;
    border-radius: 8px !important;
}

/* â”€â”€ êµ¬ë¶„ì„  â”€â”€ */
.gold-divider {
    border: none;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(200,170,80,0.4), transparent);
    margin: 14px 0;
}

/* â”€â”€ ìŠ¤í”¼ë„ˆ â”€â”€ */
[data-testid="stSpinner"] p { color: #c8a84b !important; }

/* â”€â”€ ìŠ¤í¬ë¡¤ ì—¬ë°± â”€â”€ */
.scroll-pad { height: 28px; }

/* â”€â”€ ì—ëŸ¬/ì •ë³´ ë°•ìŠ¤ â”€â”€ */
[data-testid="stAlert"] {
    background: rgba(200,170,80,0.08) !important;
    border: 1px solid rgba(200,170,80,0.3) !important;
    color: #f0e8cc !important;
    border-radius: 12px !important;
}

/* â”€â”€ ëª¨ë°”ì¼ ë°˜ì‘í˜• â”€â”€ */
@media (max-width: 640px) {
    .hero-title  { font-size: 22px; }
    .chat-bubble { font-size: 14px; padding: 13px 15px; max-width: 96%; }
}
</style>
""", unsafe_allow_html=True)


# â”€â”€ Session State ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "messages"   not in st.session_state: st.session_state.messages   = []
if "chat"       not in st.session_state: st.session_state.chat       = None
if "key_index"  not in st.session_state: st.session_state.key_index  = 0


# â”€â”€ Gemini ì´ˆê¸°í™” & API Key ìˆœí™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_chat_session(reset: bool = False):
    if reset:
        st.session_state.chat = None

    if st.session_state.chat is None:
        if not API_KEYS:
            return None
        idx = st.session_state.key_index % len(API_KEYS)
        genai.configure(api_key=API_KEYS[idx])
        model = genai.GenerativeModel(
            model_name="gemini-2.0-flash",      # ìµœì‹  ì•ˆì • ëª¨ë¸
            system_instruction=SYSTEM_INSTRUCTION,
        )
        history = [{"role": m["role"], "parts": m["parts"]} for m in st.session_state.messages]
        st.session_state.chat = model.start_chat(history=history)
    return st.session_state.chat


# â”€â”€ ì‚¬ì´ë“œë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.markdown("### âš™ï¸ ì„¤ì •")
    st.markdown("---")

    active = len(API_KEYS)
    st.markdown(
        f"**API Key ìƒíƒœ**\n\n"
        f"{'âœ…' if active >= 1 else 'âŒ'} KEY 1 &nbsp; "
        f"{'âœ…' if active >= 2 else 'â¬œ'} KEY 2 &nbsp; "
        f"{'âœ…' if active >= 3 else 'â¬œ'} KEY 3"
    )
    st.caption(f"í˜„ì¬ ì‚¬ìš© ì¤‘: KEY {(st.session_state.key_index % max(active,1)) + 1}" if active else "âš ï¸ .env íŒŒì¼ í™•ì¸ í•„ìš”")

    st.markdown("---")

    cur_model = "gemini-2.0-flash"
    st.markdown(f"**ëª¨ë¸**: `{cur_model}`")

    st.markdown("---")
    if st.button("ğŸ—‘ï¸ ëŒ€í™” ì´ˆê¸°í™”", use_container_width=True):
        st.session_state.messages  = []
        st.session_state.chat      = None
        st.session_state.key_index = 0
        st.rerun()

    st.markdown("---")
    st.caption("ğŸ’¡ API Key ë³€ê²½ì€\n`.env` íŒŒì¼ì„ ìˆ˜ì • í›„\nì•±ì„ ì¬ì‹œì‘í•˜ì„¸ìš”.")


# â”€â”€ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
active_count = len(API_KEYS)
st.markdown(f"""
<div class="hero-wrap">
  <span class="hero-icon">âœ¦</span>
  <p class="hero-title">AI MASTER MENTOR</p>
  <p class="hero-sub">Supreme Intelligence Â· Powered by Gemini</p>
  <span class="key-badge">ğŸ”‘ API KEY {active_count}/3 í™œì„±</span>
</div>
""", unsafe_allow_html=True)


# â”€â”€ API Key ì—†ì„ ë•Œ ì•ˆë‚´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if not API_KEYS:
    st.markdown("""
<div style="background:rgba(200,170,80,0.08);border:1px solid rgba(200,170,80,0.3);
            border-radius:14px;padding:24px;margin-top:20px;color:#f0e8cc;">
<h4 style="color:#c8a84b;margin-top:0">âš ï¸ API Key ì„¤ì • í•„ìš”</h4>
<p>í”„ë¡œì íŠ¸ í´ë”ì˜ <code style="color:#f0d080">.env</code> íŒŒì¼ì— ì•„ë˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:<br><br>
<code style="color:#f0d080;display:block;background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;line-height:2">
GEMINI_API_KEY_1=AIzaì—¬ê¸°ì—_ì²«ë²ˆì§¸_í‚¤_ì…ë ¥<br>
GEMINI_API_KEY_2=AIzaì—¬ê¸°ì—_ë‘ë²ˆì§¸_í‚¤_ì…ë ¥<br>
GEMINI_API_KEY_3=AIzaì—¬ê¸°ì—_ì„¸ë²ˆì§¸_í‚¤_ì…ë ¥
</code></p>
<p>ìˆ˜ì • í›„ <code style="color:#f0d080">Ctrl+C</code> â†’ ì•± ì¬ì‹œì‘</p>
<p><a href="https://aistudio.google.com/app/apikey" target="_blank" 
   style="color:#c8a84b">â†’ Google AI Studioì—ì„œ ë¬´ë£Œ ë°œê¸‰</a></p>
</div>
""", unsafe_allow_html=True)
    st.stop()


# â”€â”€ ëŒ€í™” ê¸°ë¡ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
for msg in st.session_state.messages:
    if msg["role"] == "user":
        st.markdown('<p class="role-label user-label">âœ¦ ë‚˜ì˜ ì§ˆë¬¸</p>', unsafe_allow_html=True)
        st.markdown(f'<div class="chat-bubble user-bubble">{msg["parts"][0]}</div>', unsafe_allow_html=True)
    else:
        st.markdown('<p class="role-label ai-label">â—ˆ ë§ˆìŠ¤í„° ë©˜í† </p>', unsafe_allow_html=True)
        with st.container():
            st.markdown('<div class="chat-bubble ai-bubble">', unsafe_allow_html=True)
            st.markdown(msg["parts"][0])
            st.markdown('</div>', unsafe_allow_html=True)

st.markdown('<div class="scroll-pad"></div>', unsafe_allow_html=True)


# â”€â”€ ë©”ì‹œì§€ ì²˜ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def process_message(user_text: str):
    if not user_text.strip():
        return

    # ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
    st.session_state.messages.append({"role": "user", "parts": [user_text]})
    st.markdown('<p class="role-label user-label">âœ¦ ë‚˜ì˜ ì§ˆë¬¸</p>', unsafe_allow_html=True)
    st.markdown(f'<div class="chat-bubble user-bubble">{user_text}</div>', unsafe_allow_html=True)

    # Gemini ì‘ë‹µ (Key ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ Keyë¡œ ìˆœí™˜)
    answer = None
    for attempt in range(len(API_KEYS)):
        try:
            chat = get_chat_session(reset=(attempt > 0))
            with st.spinner("âœ¦ ë§ˆìŠ¤í„° ë©˜í† ê°€ ì‹¬ì¸µ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤ ..."):
                response = chat.send_message(user_text)
                answer   = response.text
            break
        except Exception as e:
            err_msg = str(e)
            if attempt < len(API_KEYS) - 1:
                st.session_state.key_index += 1
                st.session_state.chat = None
                st.toast(f"KEY {attempt+1} í•œë„ ì´ˆê³¼, ë‹¤ìŒ KEYë¡œ ì „í™˜ ì¤‘...", icon="ğŸ”„")
            else:
                answer = f"âš ï¸ **ëª¨ë“  API Key ì˜¤ë¥˜**\n\n```\n{err_msg}\n```\n\nAPI Keyë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."

    # AI ì‘ë‹µ í‘œì‹œ
    st.session_state.messages.append({"role": "model", "parts": [answer]})
    st.markdown('<p class="role-label ai-label">â—ˆ ë§ˆìŠ¤í„° ë©˜í† </p>', unsafe_allow_html=True)
    st.markdown('<div class="chat-bubble ai-bubble">', unsafe_allow_html=True)
    st.markdown(answer)
    st.markdown('</div>', unsafe_allow_html=True)


# â”€â”€ ìŒì„± ì…ë ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
col_l, col_c, col_r = st.columns([1, 3, 1])
with col_c:
    voice_text = speech_to_text(
        language="ko",
        start_prompt="ğŸ™ï¸ ìŒì„±ìœ¼ë¡œ ì§ˆë¬¸í•˜ê¸°",
        stop_prompt="â¹ï¸  ë…¹ìŒ ì¤‘ì§€",
        just_once=True,
        use_container_width=True,
        key="mic_input",
    )

if voice_text:
    process_message(voice_text)
    st.rerun()

st.markdown('<hr class="gold-divider">', unsafe_allow_html=True)

# â”€â”€ í…ìŠ¤íŠ¸ ì…ë ¥ì°½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
user_input = st.chat_input("âœ¦  ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš” â€” í…ìŠ¤íŠ¸ ë˜ëŠ” ìœ„ ë§ˆì´í¬ ë²„íŠ¼ìœ¼ë¡œ ìŒì„± ì…ë ¥")
if user_input:
    process_message(user_input)
    st.rerun()